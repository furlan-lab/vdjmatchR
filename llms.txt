# vdjmatchR

R interface to a Rust implementation of TCR sequence matching (derived
from `vdjmatch-rs`), built via [`extendr`](https://extendr.github.io/).

## Overview

- Ships core matching logic in Rust for performance.
- Exposes an R API using extendr.
- Designed to work with VDJdb-formatted TSVs (slim or full).

## Documentation

- Website: <https://furlan-lab.github.io/vdjmatchR/>
- Reference topics and vignettes are available on the site.

## Quickstart

1.  Ensure Rust (\>= 1.70) and an R toolchain are installed.
2.  In R, install `rextendr` to aid linking (optional but recommended):
    `install.packages("rextendr")`
3.  Build + install the package from the package root: `R CMD INSTALL .`

## Examples

``` r
library(vdjmatchR)

# Use the packaged slim VDJdb (bundled with the package)
path <- vdjdb_packaged_path(use_fat_db = FALSE)
db <- RDatabase$new_from_file(path)

# Optionally update the packaged database into the package's extdata and use it
# updated_path <- vdjdb_update_latest(use_fat_db = FALSE)
# db <- RDatabase$new_from_file(updated_path)

# Or point to your own database file for this session
# vdjdb_set_user_db("/path/to/vdjdb.slim.txt.gz", use_fat_db = FALSE)
# path <- vdjdb_path(FALSE)
# db <- RDatabase$new_from_file(path)

# Or use the packaged full ("fat") VDJdb
# path_full <- vdjdb_packaged_path(use_fat_db = TRUE)
# db <- RDatabase$new_from_file(path_full)

# Filter for human TRB and higher-confidence entries
fdb <- filter_db(db, species = "HomoSapiens", gene = "TRB", min_vdjdb_score = 2)

# Match a single clonotype; get a data.frame
df <- match_tcr_df(fdb, cdr3 = "CASSLGQAYEQYF", v_segment = "TRBV12-3", j_segment = "TRBJ2-7", scope = "0,0,0,0", top_n = 5)
print(df)

# Batch match: vectors of clonotypes
cdr3s <- c("CASSLGQAYEQYF", "CASSIRSSYEQYF")
vs    <- c("TRBV12-3", "TRBV7-9")
js    <- c("TRBJ2-7",  "TRBJ2-7")
res_many <- match_tcr_many_df(fdb, cdr3s, vs, js, scope = "0,0,0,0", top_n = 3)
head(res_many)
```

## R API

- `RDatabase$new_from_file(path)`
- `RDatabase$len()`
- `RDatabase$filter(species = NULL, gene = NULL, min_vdjdb_score = 0)`
- `RDatabase$filter_by_epitope_size(min_size = 1)`
- `match_tcr(db, cdr3, v_segment, j_segment, scope, top_n)` → list
- `match_tcr_df(...)` → data.frame
- `match_tcr_many(db, cdr3, v_segment, j_segment, scope, top_n)` → list
- `match_tcr_many_df(...)` → data.frame
- `vdjdb_packaged_path(use_fat_db = FALSE)` /
  `vdjdb_path(use_fat_db = FALSE)`
- `vdjdb_set_user_db(path, use_fat_db = FALSE)` (configure your own DB
  file)

## Notes

- Results are returned as data.frames via R wrappers for convenience;
  core Rust functions return plain lists for flexibility.
- Use `scope` like `"0,0,0,0"` for exact or e.g. `"2,1,2,3"` for
  controlled fuzzy matching.

For a guided walkthrough, see the Getting started vignette:
`vignettes/getting-started.Rmd`.

# Package index

## Core functions

- [`match_tcr()`](https://furlan-lab.github.io/vdjmatchR/reference/match_tcr.md)
  : Match a single clonotype against the database. Returns a list of
  columns (vector-of-equal-length) suitable for as.data.frame in R.
- [`match_tcr_df()`](https://furlan-lab.github.io/vdjmatchR/reference/match_tcr_df.md)
  : Match one clonotype and return a data.frame
- [`match_tcr_many()`](https://furlan-lab.github.io/vdjmatchR/reference/match_tcr_many.md)
  : Batch match: vectors of cdr3/v/j; returns stacked results with query
  metadata.
- [`match_tcr_many_df()`](https://furlan-lab.github.io/vdjmatchR/reference/match_tcr_many_df.md)
  : Match many clonotypes and return a data.frame stacked across queries
- [`vdjdb_download()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_download.md)
  : Back-compat alias for updating/downloading VDJdb (one variant)
- [`vdjdb_ensure()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_ensure.md)
  : Ensure VDJdb exists locally and return the path.
- [`vdjdb_packaged_path()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_packaged_path.md)
  : Locate packaged VDJdb file bundled with vdjmatchR
- [`vdjdb_path()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_path.md)
  : Preferred VDJdb path (user-specified if set, else packaged)
- [`vdjdb_set_user_db()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_set_user_db.md)
  : Set a user-specified VDJdb path to use by default
- [`vdjdb_update()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_update.md)
  : Download/update the VDJdb files (slim and fat).
- [`vdjdb_update_all()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_update_all.md)
  : Update/download both slim and fat VDJdb files (disabled)
- [`vdjdb_update_latest()`](https://furlan-lab.github.io/vdjmatchR/reference/vdjdb_update_latest.md)
  : Update (download) the VDJdb file and return its path into extdata

## Database object

- [`RDatabase`](https://furlan-lab.github.io/vdjmatchR/reference/RDatabase.md)
  : RDatabase: Handle to a loaded VDJdb

## Helpers

- [`filter_db()`](https://furlan-lab.github.io/vdjmatchR/reference/filter_db.md)
  : Filter database via species/gene/score and return a new RDatabase
- [`filter_db_by_epitope_size()`](https://furlan-lab.github.io/vdjmatchR/reference/filter_db_by_epitope_size.md)
  : Filter database by minimum epitope size

## Package

- [`vdjmatchR-package`](https://furlan-lab.github.io/vdjmatchR/reference/vdjmatchR-package.md)
  : vdjmatchR: R Interface to VDJmatch (Rust)

# Articles

### All vignettes

- [Batch matching
  clonotypes](https://furlan-lab.github.io/vdjmatchR/articles/batch-matching.md):
- [Database management and
  filtering](https://furlan-lab.github.io/vdjmatchR/articles/database-management.md):
- [Getting started with
  vdjmatchR](https://furlan-lab.github.io/vdjmatchR/articles/getting-started.md):
- [Scoring and search
  scope](https://furlan-lab.github.io/vdjmatchR/articles/scoring-and-scope.md):
