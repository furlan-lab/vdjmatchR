---
title: "Database management and filtering"
author: "vdjmatchR Authors"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Database management and filtering}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", eval = FALSE)
```

## Installation

### Prerequisites

- R (>= 4.0)
- Rust (>= 1.70) - [Install Rust](https://www.rust-lang.org/tools/install)
- R development tools (Rtools on Windows, Xcode Command Line Tools on macOS)

### From Github in R

```{r}
devtools::install_github("furlan-lab/vdjmatchR")
```

### Clone and install (from source) in shell

```{sh}
git clone https://github.com/furlan-lab/vdjmatchR.git
cd vdjmatchR
R CMD INSTALL .
```

## Overview

This vignette covers using the packaged VDJdb, filtering it for common use cases, and how to point the package to your own database file.

## Packaged database and updates

```{r}
library(vdjmatchR)
# Use the slim VDJdb bundled with the package
path <- vdjdb_packaged_path(use_fat_db = FALSE)

# Optionally update to the latest slim/full VDJdb into the package's extdata
# path <- vdjdb_update_latest(use_fat_db = FALSE)

# Or use the full ("fat") VDJdb bundled with the package
# path <- vdjdb_packaged_path(use_fat_db = TRUE)
```

## Load and inspect

```{r}
db <- vdjdb_open_file(path)
vdjdb_len(db)
```

## Filter by species, gene, and VDJdb score

```{r}
# Human TRB, minimum VDJdb score 2
fdb <- filter_db(db, species = "HomoSapiens", gene = "TRB", min_vdjdb_score = 2)
```

## Filter by epitope size

```{r}
# Keep epitopes with at least 5 unique CDR3 entries
fdb2 <- filter_db_by_epitope_size(fdb, min_size = 5)
```

## Use your own database file

```{r, eval=FALSE}
# Tell vdjmatchR where your own VDJdb file is for this session
vdjdb_set_user_db("/path/to/vdjdb.txt.gz", use_fat_db = TRUE)
path <- vdjdb_path(use_fat_db = TRUE)
```

## Converting database to R objects for exploration

The VDJdb database can be converted to standard R data structures for exploration,
analysis, and visualization using familiar R tools.

### Database summary

Get a quick overview of database contents:

```{r}
# Print summary statistics
db_summary(db)
```

### Convert to data.table

For interactive exploration and manipulation, convert the database to a data.table:

```{r}
library(data.table)

# Convert full database to data.table
dt <- db_to_table(db)

# Or convert filtered database
dt_filtered <- db_to_table(fdb)

# Inspect structure
str(dt)
head(dt)
```

### Convert to data.frame

Alternatively, convert to a standard data.frame:

```{r}
# Convert to data.frame
df <- db_to_df(db)
```

### Exploring the database

Once converted, you can use standard R operations:

```{r}
# Count entries by species
dt[, .N, by = species][order(-N)]

# Count entries by gene
dt[, .N, by = gene][order(-N)]

# Find most common epitopes
dt[, .N, by = antigen_epitope][order(-N)][1:10]

# Explore specific viral epitopes
viral_epitopes <- dt[antigen_species %in% c("CMV", "EBV", "InfluenzaA")]
viral_epitopes[, .N, by = .(antigen_species, antigen_epitope)][order(-N)][1:15]

# Check VDJdb score distribution
dt[, .N, by = vdjdb_score][order(vdjdb_score)]
```

### Visualizing database contents

Create visualizations to understand database composition:

```{r}
library(ggplot2)

# Epitope frequency distribution
epitope_counts <- dt[, .N, by = antigen_epitope][order(-N)][1:20]
ggplot(epitope_counts, aes(x = reorder(antigen_epitope, N), y = N)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Top 20 Most Common Epitopes in VDJdb",
       x = "Epitope", y = "Number of TCR Sequences") +
  theme_minimal()

# Species distribution
species_counts <- dt[, .N, by = species]
ggplot(species_counts, aes(x = reorder(species, N), y = N)) +
  geom_col(fill = "coral") +
  coord_flip() +
  labs(title = "TCR Sequences by Species",
       x = "Species", y = "Count") +
  theme_minimal()

# Gene distribution
gene_counts <- dt[, .N, by = gene]
ggplot(gene_counts, aes(x = gene, y = N, fill = gene)) +
  geom_col() +
  labs(title = "TCR Sequences by Gene",
       x = "Gene", y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

# VDJdb score distribution
score_dist <- dt[, .N, by = vdjdb_score]
ggplot(score_dist, aes(x = factor(vdjdb_score), y = N)) +
  geom_col(fill = "darkgreen") +
  labs(title = "Distribution of VDJdb Confidence Scores",
       x = "VDJdb Score", y = "Count") +
  theme_minimal()

# CDR3 length distribution
dt[, cdr3_length := nchar(cdr3)]
ggplot(dt[cdr3_length < 30], aes(x = cdr3_length)) +
  geom_histogram(binwidth = 1, fill = "purple", alpha = 0.7) +
  labs(title = "CDR3 Sequence Length Distribution",
       x = "CDR3 Length (amino acids)", y = "Count") +
  theme_minimal()

# Antigen species breakdown for common pathogens
pathogen_counts <- dt[antigen_species %in% c("CMV", "EBV", "InfluenzaA",
                                               "SARS-CoV-2", "HIV-1", "YFV"),
                      .N, by = antigen_species][order(-N)]
ggplot(pathogen_counts, aes(x = reorder(antigen_species, N), y = N)) +
  geom_col(fill = "firebrick") +
  coord_flip() +
  labs(title = "TCR Sequences for Common Pathogens",
       x = "Pathogen", y = "Number of TCR Sequences") +
  theme_minimal()
```

### Subsetting and exporting

Extract specific subsets for further analysis:

```{r}
# Extract all CMV-specific TCRs
cmv_tcrs <- dt[antigen_species == "CMV"]

# Extract high-confidence entries
high_conf <- dt[vdjdb_score >= 2]

# Export to CSV for external analysis
fwrite(cmv_tcrs, "cmv_tcrs.csv")
```

## Reproducibility hints

- Record the file path used (`vdjdb_path()`) and include it in your analysis metadata.
- Consider snapshotting the TSV file alongside your project for long-term
  reproducibility.
